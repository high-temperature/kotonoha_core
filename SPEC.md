# ことのはコア 仕様書

## 1. 概要
「ことのはコア」は、ユーザーのタスク管理と雑談を支援する秘書型AIのコア機能を提供するRustアプリケーションである。CLIでユーザー入力を受け取り、OpenAI APIを用いて入力内容の分類（タスク/雑談）を行い、タスク管理または会話応答を実行する。TTS機能が有効な場合はVoiceVoxを利用して音声出力を行う。

## 2. 目的
- ユーザーのタスク管理を自然言語で補助する。
- 雑談を通じてユーザーに共感的な対話を提供する。
- 定期的な音声通知で軽いリマインドを行う。

## 3. 対象ユーザー
CLIで会話しながらタスクを管理したいユーザー。

## 4. システム構成
- 言語: Rust
- 外部サービス:
  - OpenAI Chat Completions API
  - VoiceVox API（TTS有効時）
- 実行形式: CLIアプリケーション

## 5. 機能仕様

### 5.1 起動・初期化
- `.env` から環境変数を読み込む。
- `TASK_FILE` が指定されていればタスク保存先を上書きする。
- `MOCK_TTS` が設定されていればTTSをモックモードに切り替える。
- `OPENAI_API_KEY` を必須とする。
- 起動後、定期発話タイマー（5分間隔）を非同期で起動する。
- 起動時にタスク状況に応じた挨拶を行う。

### 5.2 入力処理
ユーザー入力は以下の流れで処理される。

1. 空入力は無視する。
2. `exit` 入力で終了する。
3. OpenAIで入力を「タスク」か「雑談」に分類する。
4. タスクの場合:
   - 「追加」「完了」「一覧」「なし」に再分類する。
   - 追加: タスク名を抽出し登録する。
   - 完了: 類似度検索で該当タスクを完了にする。
   - 一覧: タスク一覧を表示する。
   - なし: 追加操作なしと応答する。
5. 雑談の場合:
   - 会話履歴に追加し、OpenAIから応答を取得する。
   - 応答を表示しTTSで読み上げる。

### 5.3 タスク管理
タスクは `tasks.json`（または `TASK_FILE` 指定ファイル）に保存される。
主な操作は以下の通り。

- **追加**: 新しいタスクIDを採番し追加する。
- **完了**: 類似度検索によりタスクIDを特定し完了フラグを立てる。
- **一覧**: すべてのタスクを階層構造で表示する。
- **類似度検索**:
  - Jaro-Winklerでタスクタイトルと入力文の類似度を計算する。
  - 既定の閾値（呼び出し側で指定）以上のタスクIDを返す。

### 5.4 挨拶・定時発話
- 起動時に未完了タスク数に応じた挨拶を行う。
  - 未完了0件: 完了メッセージを含む挨拶
  - 未完了あり: 件数を伝える挨拶
- 5分ごとに現在時刻と休憩促進メッセージを発話する。

### 5.5 音声出力（TTS）
- TTS機能が有効な場合:
  - VoiceVox APIを利用して音声合成を行う。
  - 話者IDは「8（春日部つむぎ）」固定。
- `MOCK_TTS` 有効時:
  - 実際の音声再生は行わず、標準出力にモックメッセージを出力する。

## 6. データ仕様

### 6.1 タスク構造
`tasks.json` に以下の構造で保存される。

```json
[
  {
    "id": 1,
    "title": "タスクタイトル",
    "done": false,
    "due_date": null,
    "priority": null,
    "status": "NotStarted",
    "visibility": "Visible",
    "notes": null,
    "tags": [],
    "subtasks": [],
    "extensions": {}
  }
]
```

### 6.2 会話API
- OpenAI Chat Completions APIへ以下形式で送信する。

```json
{
  "model": "gpt-3.5-turbo",
  "messages": [
    {
      "role": "user",
      "content": "..."
    }
  ]
}
```

## 7. 環境変数
| 変数名 | 必須 | 説明 |
| --- | --- | --- |
| `OPENAI_API_KEY` | 必須 | OpenAI APIキー |
| `TASK_FILE` | 任意 | タスク保存ファイルパス |
| `MOCK_TTS` | 任意 | TTSモックモードの有効化 |

## 8. エラー処理
- OpenAI APIが非成功ステータスの場合、詳細なエラーを返す。
- `tasks.json` が存在しない場合は空のタスクリストとして扱う。
- JSON読み込み失敗時は空リストを返却する。

## 9. 依存関係
- `reqwest`（HTTPクライアント）
- `tokio`（非同期処理）
- `dotenvy`（環境変数読み込み）
- `serde/serde_json`（JSON処理）
- `rodio`（音声再生）
- `chrono`（日時処理）
- `strsim`（文字列類似度）

## 10. 制約事項
- OpenAI API通信が必要なためネットワーク接続必須。
- TTSを利用する場合はVoiceVoxサーバーがローカルで稼働している必要がある。
  - 既定URL: `http://127.0.0.1:50021`

